---
- name: Initialize Kubernetes control-plane (master)
  hosts: master
  become: true
  vars:
    kubeadm_config_path: /etc/kubernetes/kubeadm-config.yaml

  tasks:
    - name: Create kubeadm config file
      ansible.builtin.copy:
        dest: "{{ kubeadm_config_path }}"
        content: |
          apiVersion: kubeadm.k8s.io/v1beta3
          kind: ClusterConfiguration
          networking:
            podSubnet: "{{ pod_network_cidr }}"
        owner: root
        group: root
        mode: "0644"

    - name: Initialize control-plane with kubeadm
      ansible.builtin.command: kubeadm init --config {{ kubeadm_config_path }}
      args:
        creates: /etc/kubernetes/admin.conf
      register: kubeadm_init

    - name: Show kubeadm init output
      ansible.builtin.debug:
        var: kubeadm_init.stdout_lines

    - name: Create .kube directory for ubuntu
      ansible.builtin.file:
        path: /home/ubuntu/.kube
        state: directory
        mode: "0700"
        owner: ubuntu
        group: ubuntu

    - name: Copy admin.conf to ubuntu kube config
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/ubuntu/.kube/config
        owner: ubuntu
        group: ubuntu
        mode: "0600"
        remote_src: true

    - name: Get kubeadm join command for workers
      ansible.builtin.command: kubeadm token create --print-join-command
      register: kubeadm_join_cmd

    - name: Show join command
      ansible.builtin.debug:
        var: kubeadm_join_cmd.stdout

    - name: Save join command to file
      ansible.builtin.copy:
        dest: /home/ubuntu/kubeadm_join.sh
        content: |
          #!/bin/bash
          {{ kubeadm_join_cmd.stdout }}
        owner: ubuntu
        group: ubuntu
        mode: "0755"

