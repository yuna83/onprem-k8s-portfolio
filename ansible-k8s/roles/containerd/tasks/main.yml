---
# roles/containerd/tasks/main.yml
# 모든 K8s 노드에 containerd 설치 + K8s 권장 설정

- name: Install containerd package
  ansible.builtin.apt:
    name: containerd
    state: present
    update_cache: true

- name: Create containerd config directory
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
    mode: "0755"

# 기본 설정 파일이 없으면 생성
- name: Generate default containerd config if not exists
  ansible.builtin.shell: "containerd config default > /etc/containerd/config.toml"
  args:
    creates: /etc/containerd/config.toml

# SystemdCgroup=true 로 변경 (K8s 권장)
- name: Set SystemdCgroup = true in containerd config
  ansible.builtin.replace:
    path: /etc/containerd/config.toml
    regexp: 'SystemdCgroup = false'
    replace: 'SystemdCgroup = true'
  notify: Restart containerd

- name: Enable containerd service
  ansible.builtin.systemd:
    name: containerd
    enabled: true
    state: started

